{"version":3,"file":"BMultiSelect.stories-2fe6bf05.js","sources":["../../src/components/BMultiSelect.vue"],"sourcesContent":["<script lang=\"ts\" setup>\n// https://vuejs.org/guide/essentials/event-handling.html#event-modifiers\nimport {\n  useValidationField,\n  type ValidationRule,\n} from '@/composables/Validation';\nimport {\n  ensureVisiblePosition,\n  lockScrollBody,\n  resetPosition,\n  unlockScrollBody,\n} from '@/helpers/ComponentHelper';\nimport { v4 as uuid } from 'uuid';\nimport {\n  computed,\n  nextTick,\n  onBeforeUnmount,\n  onMounted,\n  ref,\n  watch,\n} from 'vue';\nimport { useI18n } from 'vue-i18n';\nimport BCheckbox from './BCheckbox.vue';\nimport BErrorMessage from './BErrorMessage.vue';\nimport BLabel from './BLabel.vue';\nimport BTextField from './BTextField.vue';\nimport type { DisplayItem } from '@/types';\n\n/**\n * Props\n */\nexport interface BMultiSelectProps {\n  inputId?: string;\n  modelValue: Array<string | number>;\n  label?: string;\n  items: DisplayItem[];\n  disabled?: boolean;\n  placeholder?: string;\n  valueCssClass?: string;\n  menuCssClass?: string;\n  /**\n   * Array of custom validation rules.\n   */\n  validationRules?: ValidationRule[];\n  /**\n   * Validate if the field is left empty.\n   */\n  required?: boolean;\n  requiredErrorMessage?: string;\n  /**\n   * Hide the validation error message.\n   */\n  hideDetails?: boolean;\n  /**\n   * Show number of selected items.\n   */\n  showSelectedItemCount?: boolean;\n  /**\n   * Allow to type to search.\n   */\n  allowInput?: boolean;\n}\nconst props = withDefaults(defineProps<BMultiSelectProps>(), {\n  inputId: '',\n  label: '',\n  disabled: false,\n  placeholder: '',\n  valueCssClass: '',\n  menuCssClass: '',\n  validationRules: undefined,\n  required: false,\n  requiredErrorMessage: '',\n  hideDetails: false,\n  showSelectedItemCount: false,\n  allowInput: false,\n});\n\n/**\n * Events\n */\n\nconst emit = defineEmits([\n  'update:modelValue',\n  'change',\n  'open',\n  'close',\n  'change:input',\n]);\n\n/**\n * Data\n */\nconst selectEl = ref<HTMLElement | null>(null);\nconst inputRef = ref<InstanceType<typeof BTextField> | null>(null);\nconst selectMenuEl = ref<HTMLElement | null>(null);\nconst selectMenu = ref(false);\nconst { t } = useI18n();\nconst validateRequired: ValidationRule = {\n  validateRule: (val: Array<string | number>) => !!val && val.length > 0,\n  errorMessage: () =>\n    props.requiredErrorMessage || t('ds.global.field_required'),\n};\nconst inputText = ref('');\nconst selectedItems = ref<DisplayItem[]>([]);\nconst id = computed(() => props.inputId || `id-${uuid()}`);\nconst value = computed({\n  get() {\n    return props.modelValue;\n  },\n  set(val) {\n    emit('update:modelValue', val);\n  },\n});\nconst btnCssClass = computed(() => {\n  let result = `ds-border ds-drop-shadow-light ds-text-sm ds-h-[40px] ds-px-3 ds-rounded-lg ds-block ds-w-full ds-inline-flex ds-items-center ds-justify-between `;\n  result += props.disabled\n    ? `ds-cursor-not-allowed ds-bg-[#f2f2f2] ds-text-black/[0.4] `\n    : `ds-bg-white ds-text-black/[0.85] `;\n  result += !validationResult.value.valid\n    ? `ds-border-error focus:ds-ring-1 focus:ds-ring-error `\n    : `ds-border-black/10 focus:ds-border-focus focus:ds-ring-1 focus:ds-ring-focus `;\n\n  return result;\n});\nconst vRules = computed(() => {\n  let result: ValidationRule[] = [];\n\n  if (props.required) {\n    result.push(validateRequired);\n  }\n  if (props.validationRules) {\n    result = result.concat(props.validationRules);\n  }\n\n  return result.length ? result : undefined;\n});\nconst selectedItemCount = computed(() =>\n  value.value?.length > 1\n    ? ` (${t('ds.components.base.multi_select.selected_item_count', {\n        count: value.value?.length,\n      })})`\n    : '',\n);\nconst labelDisplay = computed(() =>\n  props.showSelectedItemCount\n    ? `${props.label}${selectedItemCount.value}`\n    : props.label,\n);\nconst { validate, validationResult } = useValidationField(\n  id.value,\n  value,\n  vRules.value,\n);\n\n/**\n * Watch\n */\nwatch(selectMenu, (val) => {\n  if (val) {\n    lockScrollBody();\n    ensureMenuPosition();\n    emit('open');\n  } else {\n    unlockScrollBody();\n    resetMenuPosition();\n    emit('close');\n  }\n});\nwatch(\n  value,\n  () => {\n    ensureSelectedItems();\n  },\n  {\n    deep: true,\n  },\n);\nwatch(\n  () => props.items,\n  () => {\n    if (value.value.length !== 0 && selectedItems.value.length === 0) {\n      ensureSelectedItems();\n    }\n  },\n  {\n    deep: true,\n  },\n);\n\n/**\n * Methods\n */\nconst ensureSelectedItems = () => {\n  selectedItems.value = value.value.map((v) => {\n    let item = selectedItems.value.find((i) => i.value === v);\n    if (!item) {\n      item = props.items.find((i) => i.value === v);\n    }\n    return { text: item?.text, value: v, cssClass: item?.cssClass };\n  });\n};\nconst initPressEscapeEventListener = () => {\n  document.addEventListener('keydown', closeOnEscapePressed);\n};\nconst closeOnEscapePressed = (event: KeyboardEvent) => {\n  if (event.key === 'Escape') {\n    closeSelectMenu();\n  }\n};\nconst initClickOutsideEventListener = () => {\n  document.addEventListener('click', closeOnClickOutside);\n};\nconst closeOnClickOutside = (event: any) => {\n  const refs = [selectEl.value, selectMenuEl.value];\n  const withinBoundaries = refs.some((r) => event.composedPath().includes(r));\n  if (!withinBoundaries) {\n    closeSelectMenu();\n  }\n};\nconst onClickItem = (item: DisplayItem) => {\n  const index = value.value.findIndex((v) => v === item.value);\n  if (index !== -1) {\n    value.value.splice(index, 1);\n  } else {\n    value.value.push(item.value);\n  }\n  emit('change', item.value);\n  nextTick(() => {\n    validate();\n  });\n};\nconst ensureMenuWidth = (parentEl: HTMLElement, menuEl: HTMLElement) => {\n  menuEl.style.width = `${parentEl.offsetWidth}px`;\n};\nconst ensureMenuPosition = () => {\n  nextTick(() => {\n    ensureVisiblePosition(selectEl.value!, selectMenuEl.value!);\n    ensureMenuWidth(selectEl.value!, selectMenuEl.value!);\n  });\n};\nconst resetMenuPosition = () => {\n  resetPosition(selectEl.value!, selectMenuEl.value!);\n};\nconst onChangeInputText = (text: string) => {\n  emit('change:input', text);\n};\nconst closeSelectMenu = () => {\n  selectMenu.value = false;\n  inputRef.value?.blur();\n  inputText.value = '';\n};\nconst deselectItem = (item: DisplayItem) => {\n  const index = value.value.findIndex((v) => v === item.value);\n  if (index !== -1) {\n    value.value.splice(index, 1);\n    emit('change', item.value);\n    nextTick(() => {\n      validate();\n    });\n  }\n};\nconst init = () => {\n  if (props.items.length > 0) {\n    ensureSelectedItems();\n  }\n};\ninit();\n\n/**\n * Lifecycle Hooks\n */\nonMounted(() => {\n  initPressEscapeEventListener();\n  initClickOutsideEventListener();\n});\nonBeforeUnmount(() => {\n  document.removeEventListener('keydown', closeOnEscapePressed);\n  document.removeEventListener('click', closeOnClickOutside);\n  unlockScrollBody();\n  // Make sure dropdown menu unmounted with itself\n  resetMenuPosition();\n});\n\ndefineExpose({ validate, selectMenu });\n</script>\n\n<template>\n  <div>\n    <div ref=\"selectEl\">\n      <BLabel :id=\"id\" :label=\"labelDisplay\" :required=\"required\" />\n\n      <div\n        v-if=\"props.allowInput\"\n        :class=\"{\n          'ds-border-focus ds-ring-1 ds-ring-focus':\n            selectMenu && validationResult.valid,\n          'ds-ring-1 ds-ring-error': selectMenu && !validationResult.valid,\n          'ds-border-black/10': validationResult.valid,\n          'ds-border-error': !validationResult.valid,\n        }\"\n        class=\"ds-relative ds-flex ds-flex-wrap ds-items-center ds-gap-x-1 ds-rounded-lg ds-border ds-bg-white ds-px-3 ds-py-1 ds-drop-shadow-light\"\n      >\n        <div class=\"ds-absolute ds-right-3 ds-z-[1]\">\n          <i\n            :class=\"`fa-solid fa-caret-down ds-transition-transform ${\n              selectMenu ? 'ds-rotate-180' : ''\n            }`\"\n            @click=\"inputRef?.focus()\"\n          />\n        </div>\n        <div\n          v-for=\"(item, i) in selectedItems\"\n          :key=\"`item${i}`\"\n          class=\"ds-my-0.5 ds-flex-initial ds-space-x-1 ds-rounded-lg ds-bg-black/10 ds-px-2\"\n        >\n          <span>{{ item.text }}</span>\n          <i\n            class=\"fa-solid fa-circle-xmark ds-cursor-pointer ds-text-black/60 hover:ds-text-black/40\"\n            @click=\"deselectItem(item)\"\n          />\n        </div>\n        <BTextField\n          v-if=\"props.allowInput\"\n          :id=\"id\"\n          ref=\"inputRef\"\n          v-model=\"inputText\"\n          :disabled=\"props.disabled\"\n          class=\"ds-flex-auto\"\n          hide-details\n          input-css-class=\"ds-drop-shadow-none ds-border-none !ds-ring-0 ds-px-0 !ds-h-[30px] ds-pl-0\"\n          @focus=\"selectMenu = true\"\n          @update:model-value=\"onChangeInputText\"\n        />\n      </div>\n      <button\n        v-else\n        :id=\"id\"\n        :class=\"btnCssClass\"\n        :disabled=\"disabled\"\n        type=\"button\"\n        @click=\"selectMenu = !selectMenu\"\n      >\n        <span\n          v-if=\"selectedItems.length > 0\"\n          :class=\"valueCssClass\"\n          class=\"ds-truncate ds-text-sm\"\n        >\n          {{ selectedItems?.map((s) => s.text).join(', ') }}\n        </span>\n        <span\n          v-else\n          :class=\"valueCssClass\"\n          class=\"ds-truncate ds-text-sm ds-text-black/[0.4]\"\n        >\n          {{ props.placeholder }}\n        </span>\n        &nbsp;\n        <span\n          :class=\"`${selectMenu ? 'ds-rotate-180' : ''}`\"\n          class=\"fa-solid fa-caret-down ds-text-base ds-transition-transform\"\n        >\n        </span>\n      </button>\n\n      <div\n        v-show=\"selectMenu\"\n        :id=\"`${id}Menu`\"\n        ref=\"selectMenuEl\"\n        :class=\"menuCssClass\"\n        :data-cy=\"$attrs['data-cy'] ? `${$attrs['data-cy']}Menu` : undefined\"\n        :data-ut=\"$attrs['data-ut'] ? `${$attrs['data-ut']}Menu` : undefined\"\n        class=\"ds-absolute ds-z-50 ds-min-w-[8rem] ds-py-1\"\n      >\n        <div\n          class=\"ds-max-h-72 ds-overflow-y-auto ds-rounded-lg ds-bg-white ds-shadow\"\n        >\n          <ul class=\"ds-py-1 ds-text-sm ds-text-black/[0.85]\">\n            <li\n              v-for=\"(item, index) in items\"\n              :key=\"`item${index}`\"\n              class=\"ds-cursor-pointer\"\n              @click.prevent=\"onClickItem(item)\"\n            >\n              <a\n                :class=\"\n                  item.cssClass +\n                  `${\n                    selectedItems.some((s) => s.value === item.value)\n                      ? ' ds-bg-slate-100'\n                      : ''\n                  }`\n                \"\n                class=\"ds-flex ds-items-center ds-space-x-2 ds-px-4 ds-py-2 hover:ds-bg-slate-100\"\n              >\n                <BCheckbox v-model=\"value\" :value=\"item.value\" size=\"sm\" />\n                <span>{{ item?.text }}</span>\n              </a>\n            </li>\n          </ul>\n        </div>\n      </div>\n    </div>\n\n    <BErrorMessage\n      v-if=\"!hideDetails\"\n      :error-message=\"validationResult.errorMessage()\"\n      class=\"ds-mt-1\"\n      prepend-icon=\"fa-solid fa-circle-exclamation\"\n    />\n  </div>\n</template>\n"],"names":["selectEl","ref","inputRef","selectMenuEl","selectMenu","t","useI18n","validateRequired","val","props","inputText","selectedItems","id","computed","uuid","value","emit","btnCssClass","result","validationResult","vRules","selectedItemCount","_a","_b","labelDisplay","validate","useValidationField","watch","lockScrollBody","ensureMenuPosition","unlockScrollBody","resetMenuPosition","ensureSelectedItems","v","item","i","initPressEscapeEventListener","closeOnEscapePressed","event","closeSelectMenu","initClickOutsideEventListener","closeOnClickOutside","r","onClickItem","index","nextTick","ensureMenuWidth","parentEl","menuEl","ensureVisiblePosition","resetPosition","onChangeInputText","text","deselectItem","onMounted","onBeforeUnmount","__expose"],"mappings":"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"}